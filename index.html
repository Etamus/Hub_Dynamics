<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Automação</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=Poppins:wght@600&display=swap">

    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0; padding: 20px;
            color: #333;
        }
        .container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 90%;
            max-width: 600px;
        }
        .header {
            display: flex; justify-content: center; align-items: center;
            gap: 15px; margin-bottom: 30px;
        }
        .header i { font-size: 28px; color: #007bff; }
    .header h1 { font-size: 28px; margin: 0; color: #1c1e21; font-family: 'Poppins', 'Inter', BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; font-weight: 600; }
        
        .section { margin-top: 30px; }
        .section-title {
            font-size: 20px; font-weight: 600; color: #495057;
            margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 10px;
            font-family: 'Poppins', 'Inter', BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        .button, .macro-button {
            border: none; padding: 15px 20px; border-radius: 8px; cursor: pointer;
            font-size: 16px; font-weight: 600; transition: all 0.2s ease;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .button:hover, .macro-button:hover { transform: translateY(-2px); }
        .button:disabled, .macro-button:disabled { background-color: #cccccc !important; cursor: not-allowed; transform: none; opacity: 0.7; }
        
        .button-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }
        .macro-button {
            background-color: #007bff;
            color: white;
            /* --- ALTERAÇÃO DE LARGURA AQUI --- */
            width: 80%; /* Antes estava 90% */
        }
        .macro-button:hover { background-color: #0056b3; }
        
        .sap-controls {
            max-width: 350px;
            margin: 0 auto;
        }
        
        .btn-login { background-color: #28a745; color: white; width: 100%;}
        .btn-login:hover { background-color: #218838; }

        .btn-logout { background-color: #dc3545; color: white; width: 100%;}
        .btn-logout:hover { background-color: #c82333; }

        .input-group { margin-bottom: 15px; text-align: left; }
    .input-group label { display: block; margin-bottom: 5px; font-weight: 500; font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .input-group input {
            width: 100%; padding: 10px; border: 1px solid #ced4da;
            border-radius: 6px; box-sizing: border-box;
        }
        .hidden { display: none; }

        .status-box { margin-top: 25px; padding: 12px; border-radius: 8px; font-weight: 500; min-height: 20px; opacity: 0; transition: opacity 0.3s ease; word-wrap: break-word; }
        .status-box.processing { background-color: #e9ecef; color: #495057; opacity: 1; }
        .status-box.success { background-color: #d4edda; color: #155724; opacity: 1; }
        .status-box.error { background-color: #f8d7da; color: #721c24; opacity: 1; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <i class="fas fa-cogs"></i>
            <h1>Painel de Automação</h1>
        </div>

        <div class="section">
            <h2 class="section-title">Gerenciamento SAP</h2>
            <div class="sap-controls">
                <div id="sap-credentials">
                    <div class="input-group">
                        <label for="sap-user">Usuário:</label>
                        <input type="text" id="sap-user">
                    </div>
                    <div class="input-group">
                        <label for="sap-pass">Senha:</label>
                        <input type="password" id="sap-pass">
                    </div>
                </div>
                <button id="sap-toggle-btn" class="button">Logar</button>
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">Tarefas de Automação</h2>
            <div class="button-container">
                {% for nome in macros %}
                    <button class="macro-button" data-macro-nome="{{ nome }}">{{ nome }}</button>
                {% endfor %}
            </div>
        </div>

        <div id="status" class="status-box"></div>
    </div>

    <script>
        // O JavaScript continua o mesmo, sem nenhuma alteração necessária.
        document.addEventListener('DOMContentLoaded', () => {
            let isSapLoggedIn = false;
            const statusBox = document.getElementById('status');
            const sapToggleButton = document.getElementById('sap-toggle-btn');
            const sapCredentialsDiv = document.getElementById('sap-credentials');
            const sapUser = document.getElementById('sap-user');
            const sapPass = document.getElementById('sap-pass');
            const macroButtons = document.querySelectorAll('.macro-button');

            function getAllButtons() {
                return document.querySelectorAll('.button, .macro-button');
            }

            function setProcessing(message) {
                getAllButtons().forEach(btn => btn.disabled = true);
                statusBox.className = 'status-box processing';
                statusBox.textContent = message;
            }

            function setResult(data, action) {
                if (data.status === 'sucesso') {
                    statusBox.className = 'status-box success';
                    statusBox.textContent = data.mensagem;
                    if (action === 'login') isSapLoggedIn = true;
                    if (action === 'logout') isSapLoggedIn = false;
                } else {
                    statusBox.className = 'status-box error';
                    statusBox.textContent = 'ERRO: ' + data.mensagem;
                }
                updateUiState();
            }
            
            function handleFetchError(error) {
                statusBox.className = 'status-box error';
                statusBox.textContent = 'Erro de comunicação com o servidor.';
                console.error('Erro de Fetch:', error);
                updateUiState();
            }

            function updateUiState() {
                getAllButtons().forEach(btn => btn.disabled = false);
                
                if (isSapLoggedIn) {
                    sapToggleButton.textContent = 'Deslogar';
                    sapToggleButton.className = 'button btn-logout';
                    sapCredentialsDiv.classList.add('hidden');
                    macroButtons.forEach(btn => btn.disabled = false);
                } else {
                    sapToggleButton.textContent = 'Logar';
                    sapToggleButton.className = 'button btn-login';
                    sapCredentialsDiv.classList.remove('hidden');
                    macroButtons.forEach(btn => btn.disabled = true);
                }
            }

            sapToggleButton.addEventListener('click', () => {
                const action = isSapLoggedIn ? 'logout' : 'login';
                let endpoint = '';
                let body = null;

                if (action === 'login') {
                    if (!sapUser.value || !sapPass.value) {
                        alert('Por favor, preencha o usuário e a senha.');
                        return;
                    }
                    setProcessing('Realizando login no SAP...');
                    endpoint = '/login-sap';
                    const formData = new URLSearchParams();
                    formData.append('usuario', sapUser.value);
                    formData.append('senha', sapPass.value);
                    body = formData;
                } else { // logout
                    setProcessing('Realizando logout e limpeza...');
                    endpoint = '/logout-sap';
                }

                fetch(endpoint, { method: 'POST', body: body })
                    .then(response => response.json())
                    .then(data => setResult(data, action))
                    .catch(handleFetchError);
            });
            
            macroButtons.forEach(button => {
                button.addEventListener('click', () => {
                    setProcessing('Executando macro...');
                    const formData = new URLSearchParams();
                    formData.append('macro', button.getAttribute('data-macro-nome'));

                    fetch('/executar-macro', { method: 'POST', body: formData })
                        .then(response => response.json().then(data => setResult(data, 'macro')))
                        .catch(handleFetchError);
                });
            });

            updateUiState();
        });
    </script>

</body>
</html>